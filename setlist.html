<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IGNITION - LIVE SETLIST</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --main-color: #ff4d00; --bg-color: #0a0a0a; --card-bg: #1a1a1a; }
        * { box-sizing: border-box; }
        body { background-color: var(--bg-color); color: white; font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 20px; text-align: center; min-height: 100vh; }
        .container { max-width: 600px; margin: 0 auto; }

        /* í—¤ë” */
        header h1 { letter-spacing: 2px; margin-bottom: 5px; }
        header p { color: #888; margin-top: 0; }

        /* í˜„ì¬ ì¬ìƒ ì¤‘ í‘œì‹œ (ìƒë‹¨ ê³ ì •) */
        .now-playing { background: linear-gradient(135deg, var(--main-color), #ff6a33); padding: 12px 20px; border-radius: 0 0 12px 12px; display: none; position: fixed; top: 0; left: 0; right: 0; z-index: 100; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .now-playing.visible { display: block; }
        .now-playing-inner { max-width: 600px; margin: 0 auto; }
        body.has-now-playing { padding-top: 100px; }
        .now-playing-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9; margin-bottom: 5px; }
        .now-playing-team { font-size: 0.9rem; opacity: 0.9; }
        .now-playing-song { font-size: 1.5rem; font-weight: 800; margin-top: 3px; }

        /* ì—´ê¸° ê²Œì´ì§€ */
        .hype-gauge-container { margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.2); }
        .hype-toggle-btn { background: none; border: none; color: rgba(255,255,255,0.7); font-size: 0.7rem; cursor: pointer; padding: 2px 8px; margin-left: 8px; transition: all 0.2s; }
        .hype-toggle-btn:hover { color: white; }
        .hype-gauge-content { overflow: hidden; transition: max-height 0.3s ease, opacity 0.3s ease; max-height: 200px; opacity: 1; }
        .hype-gauge-content.collapsed { max-height: 0; opacity: 0; margin-top: 0; }
        .hype-gauge-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .hype-gauge-label { font-size: 0.75rem; opacity: 0.9; }
        .hype-gauge-percent { font-size: 0.85rem; font-weight: bold; }
        .hype-gauge-bar { background: rgba(0,0,0,0.3); border-radius: 10px; height: 20px; overflow: hidden; position: relative; }
        .hype-gauge-fill { height: 100%; background: linear-gradient(90deg, #FFD700, #FF6B00, #FF0000); border-radius: 10px; transition: width 0.3s ease; width: 0%; }
        .hype-gauge-fill.maxed { animation: gaugeGlow 0.5s ease infinite alternate; }
        .hype-gauge-fill.maxed-permanent { animation: gaugeGlowPermanent 1s ease-in-out infinite; }
        @keyframes gaugeGlow { from { box-shadow: 0 0 10px #FFD700; } to { box-shadow: 0 0 25px #FF0000, 0 0 50px #FF6B00; } }
        @keyframes gaugeGlowPermanent { 0%, 100% { box-shadow: 0 0 15px #FFD700, 0 0 30px #FF6B00; } 50% { box-shadow: 0 0 30px #FF0000, 0 0 60px #FF6B00, 0 0 80px #FFD700; } }
        .hype-btn { margin-top: 10px; width: 100%; padding: 12px; background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.3); border-radius: 25px; color: white; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.1s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .hype-btn:hover { background: rgba(255,255,255,0.25); }
        .hype-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.3); }
        .hype-btn .fire-icon { font-size: 1.2rem; }

        /* í­ë°œ ì´í™íŠ¸ ì˜¤ë²„ë ˆì´ */
        .hype-explosion { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 400; display: none; align-items: center; justify-content: center; pointer-events: none; box-shadow: inset 0 0 100px 50px rgba(255,0,0,0.8), inset 0 0 200px 100px rgba(255,107,0,0.5); animation: explosionGlow 300s ease forwards, explosionShake 0.5s ease-in-out; }
        .hype-explosion.visible { display: flex; }
        .hype-explosion-text { font-size: 3.5rem; font-weight: 900; color: white; text-shadow: 0 0 30px #FFD700, 0 0 60px #FF6B00, 0 0 100px #FF0000; animation: explosionPop 0.5s ease, textPulse 0.3s ease infinite; }
        @keyframes explosionGlow { 0% { box-shadow: inset 0 0 150px 80px rgba(255,0,0,0.9), inset 0 0 300px 150px rgba(255,107,0,0.7); } 2% { box-shadow: inset 0 0 100px 50px rgba(255,0,0,0.8), inset 0 0 200px 100px rgba(255,107,0,0.5); } 98% { box-shadow: inset 0 0 80px 40px rgba(255,0,0,0.6), inset 0 0 150px 80px rgba(255,107,0,0.3); } 100% { box-shadow: inset 0 0 0 0 transparent; } }
        @keyframes explosionShake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); } 20%, 40%, 60%, 80% { transform: translateX(8px); } }
        @keyframes explosionPop { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.3); } 100% { transform: scale(1); opacity: 1; } }
        @keyframes textPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        /* ì…‹ë¦¬ìŠ¤íŠ¸ ì„¹ì…˜ */
        .setlist-section { text-align: left; margin-bottom: 30px; }
        .team-block { background: var(--card-bg); border-radius: 12px; padding: 20px; margin-bottom: 15px; border: 1px solid #333; }
        .team-block.has-active { border-color: var(--main-color); box-shadow: 0 0 20px rgba(255, 77, 0, 0.15); }
        .team-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .team-name { font-size: 1.1rem; font-weight: bold; color: var(--main-color); }
        .team-badge { background: #333; color: #888; font-size: 0.7rem; padding: 3px 8px; border-radius: 10px; }
        .team-block.has-active .team-badge { background: var(--main-color); color: white; }
        .team-members { display: grid; grid-template-columns: 1fr 1fr; gap: 6px 12px; font-size: 0.75rem; color: #999; margin-bottom: 15px; padding: 12px; background: #1f1f1f; border-radius: 8px; }
        .team-members .member-item { display: flex; gap: 6px; }
        .team-members .part { color: #666; flex-shrink: 0; min-width: 55px; }
        .team-members .names { line-height: 1.5; }

        /* ê³¡ ë¦¬ìŠ¤íŠ¸ */
        .song-list { display: flex; flex-direction: column; gap: 8px; }
        .song-item { display: flex; align-items: center; gap: 12px; padding: 12px 15px; background: #252525; border-radius: 8px; transition: all 0.3s; cursor: default; }
        .song-item.active { background: var(--main-color); transform: scale(1.02); box-shadow: 0 4px 15px rgba(255, 77, 0, 0.4); }
        .song-number { width: 24px; height: 24px; border-radius: 50%; background: #333; color: #888; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .song-item.active .song-number { background: rgba(255,255,255,0.2); color: white; }
        .song-title { font-size: 0.95rem; flex: 1; }
        .song-item.active .song-title { font-weight: bold; }
        .playing-icon { display: none; }
        .song-item.active .playing-icon { display: block; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* í•˜íŠ¸ ë²„íŠ¼ */
        .heart-btn { display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.1); border: none; color: #ff6b81; padding: 6px 10px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; flex-shrink: 0; }
        .heart-btn:hover { background: rgba(255,255,255,0.2); transform: scale(1.1); }
        .heart-btn:active { transform: scale(0.95); }
        .heart-btn.clicked { animation: heartPop 0.3s ease; }
        .heart-btn.disabled { opacity: 0.4; cursor: not-allowed; pointer-events: none; }
        .heart-count { font-size: 0.8rem; color: #ccc; min-width: 20px; }
        .song-item.active .heart-btn { background: rgba(255,255,255,0.2); }
        .song-item.active .heart-count { color: white; }
        @keyframes heartPop { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }

        /* í•˜íŠ¸ í”Œë¡œíŒ… ì• ë‹ˆë©”ì´ì…˜ */
        .floating-heart { position: fixed; pointer-events: none; font-size: 1.5rem; animation: floatUp 1s ease-out forwards; z-index: 200; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-80px) scale(1.5); } }

        /* ê´€ë¦¬ì ëª¨ë“œ - ê³¡ í´ë¦­ ê°€ëŠ¥ */
        .admin-mode .song-item { cursor: pointer; }
        .admin-mode .song-item:hover:not(.active) { background: #333; }

        /* ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ */
        .password-section { margin-top: 30px; padding-top: 30px; border-top: 1px solid #333; }
        .password-input-group { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
        .password-input-group input { background: #222; border: 1px solid #444; color: white; padding: 12px 15px; border-radius: 8px; font-size: 1rem; width: 200px; }
        .password-input-group input:focus { outline: none; border-color: var(--main-color); }
        .password-input-group button { background: var(--main-color); border: none; color: white; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .password-input-group button:hover { background: #ff6a33; }
        .error-msg { color: #ff4444; font-size: 0.85rem; margin-top: 10px; display: none; }

        /* ê´€ë¦¬ì ì»¨íŠ¸ë¡¤ */
        .admin-controls { margin-top: 20px; padding-top: 20px; border-top: 1px solid #333; display: none; }
        .admin-controls.visible { display: block; }
        .admin-controls-title { font-size: 0.85rem; color: #888; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; }
        .admin-controls-title span { color: #4CAF50; }
        .special-btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .special-btn { background: #222; border: 1px solid #444; color: white; padding: 15px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; }
        .special-btn:hover { border-color: var(--main-color); background: #2a2a2a; }

        /* ë¦¬ë”ë³´ë“œ í”Œë¡œíŒ… ë²„íŠ¼ */
        .leaderboard-fab { position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px; background: linear-gradient(135deg, #FFD700, #FFA500); border: none; border-radius: 50%; cursor: pointer; font-size: 1.5rem; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4); z-index: 150; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
        .leaderboard-fab:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6); }
        .leaderboard-fab:active { transform: scale(0.95); }

        /* ë¦¬ë”ë³´ë“œ ëª¨ë‹¬ */
        .leaderboard-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 200; display: none; align-items: center; justify-content: center; padding: 20px; }
        .leaderboard-overlay.visible { display: flex; }
        .leaderboard-modal { background: var(--card-bg); border-radius: 16px; width: 100%; max-width: 400px; max-height: 80vh; overflow: hidden; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .leaderboard-header { background: linear-gradient(135deg, #FFD700, #FFA500); padding: 20px; text-align: center; }
        .leaderboard-header h2 { margin: 0; font-size: 1.3rem; color: #000; }
        .leaderboard-header p { margin: 5px 0 0; font-size: 0.8rem; color: rgba(0,0,0,0.6); }
        .leaderboard-content { padding: 15px; max-height: 50vh; overflow-y: auto; }
        .leaderboard-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: #252525; border-radius: 10px; margin-bottom: 10px; }
        .leaderboard-item.rank-1 { background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,165,0,0.1)); border: 1px solid rgba(255,215,0,0.3); }
        .leaderboard-item.rank-2 { background: linear-gradient(135deg, rgba(192,192,192,0.2), rgba(169,169,169,0.1)); border: 1px solid rgba(192,192,192,0.3); }
        .leaderboard-item.rank-3 { background: linear-gradient(135deg, rgba(205,127,50,0.2), rgba(184,115,51,0.1)); border: 1px solid rgba(205,127,50,0.3); }
        .leaderboard-rank { width: 32px; height: 32px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem; flex-shrink: 0; }
        .rank-1 .leaderboard-rank { background: #FFD700; color: #000; }
        .rank-2 .leaderboard-rank { background: #C0C0C0; color: #000; }
        .rank-3 .leaderboard-rank { background: #CD7F32; color: #fff; }
        .leaderboard-info { flex: 1; min-width: 0; }
        .leaderboard-song { font-weight: bold; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .leaderboard-team { font-size: 0.75rem; color: #888; margin-top: 2px; }
        .leaderboard-hearts { color: #ff6b81; font-weight: bold; display: flex; align-items: center; gap: 4px; flex-shrink: 0; }
        .leaderboard-close { display: block; width: 100%; padding: 15px; background: #333; border: none; color: white; font-size: 0.9rem; cursor: pointer; transition: background 0.2s; }
        .leaderboard-close:hover { background: #444; }
        .leaderboard-empty { text-align: center; padding: 30px; color: #666; }

        /* ì¶”ì²¨ ì°¸ì—¬ í”Œë¡œíŒ… ë²„íŠ¼ */
        .raffle-fab { position: fixed; bottom: 24px; left: 24px; width: 56px; height: 56px; background: linear-gradient(135deg, #9b59b6, #8e44ad); border: none; border-radius: 50%; cursor: pointer; font-size: 1.5rem; box-shadow: 0 4px 15px rgba(155, 89, 182, 0.4); z-index: 150; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
        .raffle-fab:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(155, 89, 182, 0.6); }
        .raffle-fab.joined { background: linear-gradient(135deg, #27ae60, #2ecc71); box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4); }
        .raffle-fab.joined:hover { box-shadow: 0 6px 20px rgba(46, 204, 113, 0.6); }

        /* ì¶”ì²¨ ëª¨ë‹¬ */
        .raffle-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 200; display: none; align-items: center; justify-content: center; padding: 20px; }
        .raffle-overlay.visible { display: flex; }
        .raffle-modal { background: var(--card-bg); border-radius: 16px; width: 100%; max-width: 400px; overflow: hidden; animation: slideUp 0.3s ease; }
        .raffle-header { background: linear-gradient(135deg, #9b59b6, #8e44ad); padding: 20px; text-align: center; }
        .raffle-header.joined { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .raffle-header h2 { margin: 0; font-size: 1.3rem; }
        .raffle-header p { margin: 5px 0 0; font-size: 0.8rem; opacity: 0.8; }
        .raffle-content { padding: 25px; text-align: center; }
        .raffle-number { font-size: 4rem; font-weight: 900; color: var(--main-color); margin: 20px 0; letter-spacing: 4px; }
        .raffle-status { font-size: 0.9rem; color: #888; margin-bottom: 20px; }
        .raffle-join-btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #9b59b6, #8e44ad); border: none; border-radius: 10px; color: white; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .raffle-join-btn:hover { transform: scale(1.02); }
        .raffle-join-btn:disabled { background: #333; color: #666; cursor: default; transform: none; }
        .raffle-join-btn.interaction-disabled { background: #444; color: #888; cursor: not-allowed; }
        .raffle-participant-count { font-size: 0.85rem; color: #888; margin-top: 15px; }
        .raffle-close { display: block; width: 100%; padding: 15px; background: #333; border: none; color: white; font-size: 0.9rem; cursor: pointer; }
        .raffle-close:hover { background: #444; }

        /* ê´€ë¦¬ì ì¶”ì²¨ ì»¨íŠ¸ë¡¤ */
        .raffle-admin { margin-top: 15px; padding-top: 15px; border-top: 1px solid #333; }
        .raffle-admin-title { font-size: 0.8rem; color: #888; margin-bottom: 10px; }
        .raffle-draw-btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #e74c3c, #c0392b); border: none; border-radius: 10px; color: white; font-size: 1rem; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
        .raffle-draw-btn:hover { opacity: 0.9; }
        .raffle-reset-btn { width: 100%; padding: 12px; background: transparent; border: 1px solid #444; border-radius: 8px; color: #888; font-size: 0.85rem; cursor: pointer; }
        .raffle-reset-btn:hover { border-color: #666; color: #aaa; }

        /* ë‹¹ì²¨ ê²°ê³¼ ëª¨ë‹¬ */
        .winner-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 300; display: none; align-items: center; justify-content: center; padding: 20px; }
        .winner-overlay.visible { display: flex; }
        .winner-modal { text-align: center; animation: winnerPop 0.5s ease; }
        @keyframes winnerPop { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        .winner-icon { font-size: 5rem; margin-bottom: 20px; }
        .winner-label { font-size: 1.2rem; color: #888; margin-bottom: 10px; }
        .winner-number { font-size: 6rem; font-weight: 900; background: linear-gradient(135deg, #FFD700, #FFA500); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .my-number-section { margin-top: 25px; padding-top: 20px; border-top: 1px solid #333; }
        .my-number-label { font-size: 0.9rem; color: #666; margin-bottom: 5px; }
        .my-number { font-size: 2.5rem; font-weight: 700; color: #9b59b6; }
        .winner-result { margin-top: 15px; font-size: 1.1rem; font-weight: bold; min-height: 30px; }
        .winner-result.is-winner { color: #FFD700; font-size: 1.5rem; animation: winnerPulse 0.5s ease infinite alternate; }
        @keyframes winnerPulse { from { transform: scale(1); } to { transform: scale(1.1); } }
        .winner-modal.is-winner { background: radial-gradient(circle, rgba(255,215,0,0.1) 0%, transparent 70%); }
        .winner-close { margin-top: 30px; padding: 15px 40px; background: var(--main-color); border: none; border-radius: 10px; color: white; font-size: 1rem; cursor: pointer; }

        /* ì±„íŒ… í”Œë¡œíŒ… ë²„íŠ¼ */
        .chat-fab { position: fixed; bottom: 88px; right: 24px; width: 56px; height: 56px; background: linear-gradient(135deg, #3498db, #2980b9); border: none; border-radius: 50%; cursor: pointer; font-size: 1.5rem; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4); z-index: 150; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
        .chat-fab:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(52, 152, 219, 0.6); }
        .chat-fab:active { transform: scale(0.95); }
        .chat-fab .unread-badge { position: absolute; top: -2px; right: -2px; width: 18px; height: 18px; background: #e74c3c; border-radius: 50%; font-size: 0.65rem; display: flex; align-items: center; justify-content: center; font-weight: bold; display: none; }
        .chat-fab .unread-badge.visible { display: flex; }

        /* ì±„íŒ… ëª¨ë‹¬ */
        .chat-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 200; display: none; align-items: flex-end; justify-content: center; padding: 0; }
        .chat-overlay.visible { display: flex; }
        .chat-modal { background: var(--card-bg); border-radius: 16px 16px 0 0; width: 100%; max-width: 500px; height: 70vh; display: flex; flex-direction: column; animation: slideUp 0.3s ease; }
        .chat-header { background: linear-gradient(135deg, #3498db, #2980b9); padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-radius: 16px 16px 0 0; }
        .chat-header h2 { margin: 0; font-size: 1.1rem; }
        .chat-header-info { font-size: 0.75rem; opacity: 0.8; }
        .chat-close-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0; line-height: 1; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .chat-message { background: #252525; padding: 10px 14px; border-radius: 12px; max-width: 85%; word-break: break-word; }
        .chat-message.mine { background: #3498db; align-self: flex-end; }
        .chat-message-text { font-size: 0.9rem; line-height: 1.4; }
        .chat-message-time { font-size: 0.65rem; color: #888; margin-top: 4px; text-align: right; }
        .chat-message.mine .chat-message-time { color: rgba(255,255,255,0.6); }
        .chat-empty { text-align: center; color: #666; padding: 40px 20px; }
        .chat-input-area { padding: 15px; border-top: 1px solid #333; display: flex; gap: 10px; }
        .chat-input { flex: 1; background: #252525; border: 1px solid #444; color: white; padding: 12px 15px; border-radius: 25px; font-size: 0.9rem; outline: none; }
        .chat-input:focus { border-color: #3498db; }
        .chat-input::placeholder { color: #666; }
        .chat-send-btn { width: 44px; height: 44px; background: linear-gradient(135deg, #3498db, #2980b9); border: none; border-radius: 50%; color: white; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .chat-send-btn:hover { transform: scale(1.05); }
        .chat-send-btn:disabled { background: #333; color: #666; cursor: default; transform: none; }
        .chat-cooldown { font-size: 0.75rem; color: #e74c3c; text-align: center; padding: 5px; display: none; }
        .chat-cooldown.visible { display: block; }
        .donate-btn { width: 44px; height: 44px; background: linear-gradient(135deg, #f1c40f, #f39c12); border: none; border-radius: 50%; color: white; font-size: 1.2rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .donate-btn:hover { transform: scale(1.05); }

        /* í›„ì› ëª¨ë‹¬ */
        .donate-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 250; display: none; align-items: center; justify-content: center; padding: 20px; }
        .donate-overlay.visible { display: flex; }
        .donate-modal { background: var(--card-bg); border-radius: 16px; width: 100%; max-width: 320px; overflow: hidden; animation: slideUp 0.3s ease; }
        .donate-header { background: linear-gradient(135deg, #f1c40f, #f39c12); padding: 20px; text-align: center; }
        .donate-header h2 { margin: 0; font-size: 1.3rem; color: #000; }
        .donate-header p { margin: 5px 0 0; font-size: 0.8rem; color: rgba(0,0,0,0.6); }
        .donate-content { padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .donate-amount-btn { padding: 15px; background: #252525; border: 2px solid #444; border-radius: 10px; color: white; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .donate-amount-btn:hover { border-color: #f1c40f; background: #333; }
        .donate-close { display: block; width: 100%; padding: 15px; background: #333; border: none; color: white; font-size: 0.9rem; cursor: pointer; }
        .donate-close:hover { background: #444; }

        /* í›„ì› ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
        .chat-donate-notice { align-self: center; background: linear-gradient(135deg, #f1c40f, #f39c12); color: #000; padding: 10px 18px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }

        /* ì±„íŒ… ë©”ì‹œì§€ ìˆ¨ê¹€ ë²„íŠ¼ (ê´€ë¦¬ììš©) */
        .chat-message-wrapper { display: flex; align-items: flex-start; gap: 8px; }
        .chat-message-wrapper.mine { flex-direction: row-reverse; }
        .chat-hide-btn { background: #e74c3c; border: none; color: white; width: 24px; height: 24px; border-radius: 50%; font-size: 0.7rem; cursor: pointer; opacity: 0; transition: opacity 0.2s; flex-shrink: 0; margin-top: 8px; }
        .chat-message-wrapper:hover .chat-hide-btn { opacity: 1; }
        .chat-message.hidden { opacity: 0.4; background: #1a1a1a; }
        .chat-message.hidden .chat-message-text { text-decoration: line-through; color: #666; }

        /* ì±„íŒ… ì‹œìŠ¤í…œ ì•Œë¦¼ */
        .chat-system-notice { align-self: center; background: #333; color: #aaa; padding: 8px 16px; border-radius: 20px; font-size: 0.75rem; display: flex; align-items: center; gap: 6px; }
        .chat-system-notice .notice-icon { font-size: 0.85rem; }

        /* ì „ì²´ ì±„íŒ… ëª¨ë‹¬ */
        .all-chat-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 250; display: none; align-items: center; justify-content: center; padding: 20px; }
        .all-chat-overlay.visible { display: flex; }
        .all-chat-modal { background: var(--card-bg); border-radius: 16px; width: 100%; max-width: 500px; max-height: 85vh; display: flex; flex-direction: column; animation: slideUp 0.3s ease; }
        .all-chat-header { background: linear-gradient(135deg, #8e44ad, #9b59b6); padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-radius: 16px 16px 0 0; }
        .all-chat-header h2 { margin: 0; font-size: 1.1rem; }
        .all-chat-header-info { font-size: 0.75rem; opacity: 0.8; }
        .all-chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .all-chat-item { background: #252525; padding: 10px 14px; border-radius: 10px; }
        .all-chat-item.mine { background: #3498db; }
        .all-chat-item.hidden-msg { opacity: 0.4; background: #1a1a1a; }
        .all-chat-text { font-size: 0.9rem; line-height: 1.4; word-break: break-word; }
        .all-chat-time { font-size: 0.65rem; color: #888; margin-top: 4px; }
        .all-chat-item.mine .all-chat-time { color: rgba(255,255,255,0.6); }
        .all-chat-close { display: block; width: 100%; padding: 15px; background: #333; border: none; color: white; font-size: 0.9rem; cursor: pointer; border-radius: 0 0 16px 16px; }
        .all-chat-close:hover { background: #444; }
        .all-chat-loading { text-align: center; color: #888; padding: 40px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸ”¥ IGNITION</h1>
        <p>2026.01.17 @í™ëŒ€ í´ëŸ½FF</p>
    </header>
</div>

<!-- í˜„ì¬ ì¬ìƒ ì¤‘ (ìƒë‹¨ ê³ ì •) -->
<section class="now-playing" id="now-playing">
    <div class="now-playing-inner">
        <div class="now-playing-label">â— NOW PLAYING</div>
        <div class="now-playing-team" id="current-team"></div>
        <div class="now-playing-song" id="current-song"></div>
    </div>
</section>

<!-- í­ë°œ ì´í™íŠ¸ -->
<div class="hype-explosion" id="hype-explosion">
    <div class="hype-explosion-text"></div>
</div>

<div class="container">

    <!-- ì „ì²´ ì…‹ë¦¬ìŠ¤íŠ¸ -->
    <section class="setlist-section" id="setlist"></section>

    <!-- ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì„¹ì…˜ -->
    <section class="password-section" id="password-section" style="display: none;">
        <p style="color: #888; margin-bottom: 5px;">ğŸ”’ ê´€ë¦¬ì ì¸ì¦</p>
        <div class="password-input-group">
            <input type="password" id="admin-password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
            <button onclick="checkPassword()">í™•ì¸</button>
        </div>
        <p class="error-msg" id="error-msg">ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
    </section>

    <!-- ê´€ë¦¬ì íŠ¹ìˆ˜ ì»¨íŠ¸ë¡¤ -->
    <section class="admin-controls" id="admin-controls">
        <div class="admin-controls-title">
            ğŸ›ï¸ ê´€ë¦¬ì ì»¨íŠ¸ë¡¤
            <span>âœ“ ì¸ì¦ë¨</span>
        </div>

        <!-- ê´€ê° ì°¸ì—¬ ê¸°ëŠ¥ ì¼ê´„ ê´€ë¦¬ -->
        <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, rgba(255,77,0,0.1), rgba(255,106,51,0.05)); border: 1px solid rgba(255,77,0,0.3); border-radius: 12px;">
            <div style="font-size: 0.9rem; color: var(--main-color); margin-bottom: 12px; font-weight: bold;">ğŸ® ê´€ê° ì°¸ì—¬ ê¸°ëŠ¥ (ì¼ê´„ ê´€ë¦¬)</div>
            <div style="font-size: 0.75rem; color: #888; margin-bottom: 12px;">í•˜íŠ¸, ì±„íŒ…, ì¶”ì²¨ ì°¸ì—¬ë¥¼ í•œ ë²ˆì— ì—´ê±°ë‚˜ ë‹«ìŠµë‹ˆë‹¤</div>
            <div style="display: flex; gap: 10px;">
                <button class="special-btn" id="interaction-open-btn" style="flex:1; background: linear-gradient(135deg, #27ae60, #2ecc71); border: none; color: white;" onclick="setInteractionEnabled(true)">ğŸ”“ ì°¸ì—¬ ì—´ê¸°</button>
                <button class="special-btn" id="interaction-close-btn" style="flex:1; background: linear-gradient(135deg, #e74c3c, #c0392b); border: none; color: white;" onclick="setInteractionEnabled(false)">ğŸ”’ ì°¸ì—¬ ë‹«ê¸°</button>
            </div>
            <div style="margin-top: 10px; text-align: center;">
                <span id="interaction-status" style="font-size: 0.8rem; color: #e74c3c;">í˜„ì¬: ë‹«í˜ ğŸ”’</span>
            </div>
        </div>

        <div class="special-btn-grid">
            <button class="special-btn" onclick="updateLive('', '')">â¸ï¸ ëŒ€ê¸° ìƒíƒœ</button>
            <button class="special-btn" onclick="updateLive('ğŸ‰', 'ê³µì—°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤')">ğŸ”š ê³µì—° ì¢…ë£Œ</button>
        </div>
        <button class="special-btn" style="width:100%; margin-top:10px; color:#ff6b81;" onclick="resetHearts()">ğŸ—‘ï¸ í•˜íŠ¸ ì „ì²´ ì´ˆê¸°í™”</button>

        <!-- ì¶”ì²¨ ê´€ë¦¬ì ì»¨íŠ¸ë¡¤ -->
        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #333;">
            <div style="font-size: 0.85rem; color: #888; margin-bottom: 10px;">ğŸŸï¸ ì¶”ì²¨ ê´€ë¦¬ <span id="admin-raffle-count" style="color: #9b59b6;">(0ëª… ì°¸ì—¬ì¤‘)</span></div>
            <div class="special-btn-grid">
                <button class="special-btn" style="background: linear-gradient(135deg, #9b59b6, #8e44ad); border: none;" onclick="drawWinner()">ğŸ‰ ì¶”ì²¨í•˜ê¸°</button>
                <button class="special-btn" onclick="resetRaffle()">ğŸ—‘ï¸ ì°¸ì—¬ì ì´ˆê¸°í™”</button>
            </div>
        </div>

        <!-- ì±„íŒ… ê´€ë¦¬ì ì»¨íŠ¸ë¡¤ -->
        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #333;">
            <div style="font-size: 0.85rem; color: #888; margin-bottom: 10px;">ğŸ’¬ ì±„íŒ… ê´€ë¦¬ <span id="admin-chat-status" style="color: #27ae60;">(í™œì„±í™”)</span></div>
            <div class="special-btn-grid">
                <button class="special-btn" id="chat-toggle-btn" style="color:#3498db;" onclick="toggleChatEnabled()">ğŸ”’ ì±„íŒ… ë¹„í™œì„±í™”</button>
                <button class="special-btn" id="chat-visible-btn" style="color:#9b59b6;" onclick="toggleChatVisible()">ğŸ‘ï¸ ì±„íŒ… ìˆ¨ê¸°ê¸°</button>
            </div>
            <button class="special-btn" style="width:100%; margin-top:10px; color:#e74c3c;" onclick="resetChat()">ğŸ—‘ï¸ ì±„íŒ… ì „ì²´ ì‚­ì œ</button>
        </div>

        <!-- ì—´ê¸° ê²Œì´ì§€ ê´€ë¦¬ì ì»¨íŠ¸ë¡¤ -->
        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #333;">
            <div style="font-size: 0.85rem; color: #888; margin-bottom: 10px;">ğŸ”¥ ì—´ê¸° ê²Œì´ì§€ ê´€ë¦¬ <span id="admin-hype-target" style="color: #FF6B00;">(ëª©í‘œ: 300)</span></div>
            <div class="special-btn-grid">
                <button class="special-btn" style="color:#FFD700;" onclick="setHypeTarget()">ğŸ¯ ëª©í‘œê°’ ì„¤ì •</button>
                <button class="special-btn" style="color:#ff6b81;" onclick="resetHypeExploded()">ğŸ—‘ï¸ í­ë°œ ê¸°ë¡ ì´ˆê¸°í™”</button>
            </div>
            <div class="special-btn-grid" style="margin-top:10px;">
                <button class="special-btn" style="color:#FF4500;" onclick="triggerManualExplosion()">ğŸ”¥ ë¶ˆì§€ë¥´ê¸°</button>
                <button class="special-btn" style="color:#666;" onclick="turnOffExplosion()">ğŸ’¨ ë¶ˆë„ê¸°</button>
            </div>
        </div>
    </section>
</div>

<!-- ì¶”ì²¨ í”Œë¡œíŒ… ë²„íŠ¼ -->
<button class="raffle-fab" id="raffle-fab" onclick="openRaffle()">ğŸŸï¸</button>

<!-- ì±„íŒ… í”Œë¡œíŒ… ë²„íŠ¼ -->
<button class="chat-fab" id="chat-fab" onclick="openChat()">
    ğŸ’¬
    <span class="unread-badge" id="unread-badge">0</span>
</button>

<!-- ë¦¬ë”ë³´ë“œ í”Œë¡œíŒ… ë²„íŠ¼ -->
<button class="leaderboard-fab" onclick="openLeaderboard()">ğŸ†</button>

<!-- ì±„íŒ… ëª¨ë‹¬ -->
<div class="chat-overlay" id="chat-overlay" onclick="closeChat(event)">
    <div class="chat-modal" onclick="event.stopPropagation()">
        <div class="chat-header">
            <div>
                <h2>ğŸ’¬ ì‹¤ì‹œê°„ ì±„íŒ…</h2>
                <div class="chat-header-info">ìµœëŒ€ 30ì Â· 10ì´ˆ ì¿¨íƒ€ì„</div>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button onclick="openAllChat()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; cursor: pointer;">ì „ì²´ ì¡°íšŒ</button>
                <button class="chat-close-btn" onclick="closeChat()">Ã—</button>
            </div>
        </div>
        <div class="chat-messages" id="chat-messages">
            <div class="chat-empty">ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        </div>
        <div class="chat-cooldown" id="chat-cooldown">ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë ¤ë©´ ì ì‹œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
        <div class="chat-input-area">
            <input type="text" class="chat-input" id="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥ (ìµœëŒ€ 30ì)" maxlength="30" onkeypress="handleChatKeypress(event)">
            <button class="chat-send-btn" id="chat-send-btn" onclick="sendChat()">â¤</button>
            <button class="donate-btn" onclick="openDonateModal()">$</button>
        </div>
    </div>
</div>

<!-- í›„ì› ëª¨ë‹¬ -->
<div class="donate-overlay" id="donate-overlay" onclick="closeDonateModal(event)">
    <div class="donate-modal" onclick="event.stopPropagation()">
        <div class="donate-header">
            <h2>ğŸ’¸ í›„ì›í•˜ê¸°</h2>
            <p>ê³µì—°íŒ€ì„ ì‘ì›í•´ì£¼ì„¸ìš”!</p>
        </div>
        <div class="donate-content">
            <button class="donate-amount-btn" onclick="sendDonation(1000)">1,000ì›</button>
            <button class="donate-amount-btn" onclick="sendDonation(2000)">2,000ì›</button>
            <button class="donate-amount-btn" onclick="sendDonation(5000)">5,000ì›</button>
            <button class="donate-amount-btn" onclick="sendDonation(10000)">10,000ì›</button>
        </div>
        <button class="donate-close" onclick="closeDonateModal()">ë‹«ê¸°</button>
    </div>
</div>

<!-- ì¶”ì²¨ ëª¨ë‹¬ -->
<div class="raffle-overlay" id="raffle-overlay" onclick="closeRaffle(event)">
    <div class="raffle-modal" onclick="event.stopPropagation()">
        <div class="raffle-header" id="raffle-header">
            <h2>ğŸŸï¸ ì¶”ì²¨ ì°¸ì—¬</h2>
            <p>ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¶”ì²¨ì— ì°¸ì—¬í•˜ì„¸ìš”!</p>
        </div>
        <div class="raffle-content">
            <div class="raffle-status" id="raffle-status">ì°¸ì—¬í•˜ë©´ ë²ˆí˜¸ë¥¼ ë°›ì•„ìš”</div>
            <div class="raffle-number" id="raffle-number">-</div>
            <button class="raffle-join-btn" id="raffle-join-btn" onclick="joinRaffle()">ì¶”ì²¨ ì°¸ì—¬í•˜ê¸°</button>
            <div class="raffle-participant-count" id="raffle-participant-count">í˜„ì¬ ì°¸ì—¬ì: 0ëª…</div>

            <!-- ê´€ë¦¬ì ì „ìš© -->
            <div class="raffle-admin" id="raffle-admin" style="display: none;">
                <div class="raffle-admin-title">ğŸ”’ ê´€ë¦¬ì ì „ìš©</div>
                <button class="raffle-draw-btn" onclick="drawWinner()">ğŸ‰ ì¶”ì²¨í•˜ê¸°!</button>
                <button class="raffle-reset-btn" onclick="resetRaffle()">ì°¸ì—¬ì ì´ˆê¸°í™”</button>
            </div>
        </div>
        <button class="raffle-close" onclick="closeRaffle()">ë‹«ê¸°</button>
    </div>
</div>

<!-- ë‹¹ì²¨ ê²°ê³¼ ëª¨ë‹¬ -->
<div class="winner-overlay" id="winner-overlay" onclick="closeWinner()">
    <div class="winner-modal">
        <div class="winner-icon" id="winner-icon">ğŸŠ</div>
        <div class="winner-label">ë‹¹ì²¨ ë²ˆí˜¸</div>
        <div class="winner-number" id="winner-number">000</div>
        <div class="my-number-section" id="my-number-section">
            <div class="my-number-label">ë‚´ ë²ˆí˜¸</div>
            <div class="my-number" id="my-number-display">-</div>
        </div>
        <div class="winner-result" id="winner-result"></div>
        <button class="winner-close" onclick="closeWinner()">í™•ì¸</button>
    </div>
</div>

<!-- ë¦¬ë”ë³´ë“œ ëª¨ë‹¬ -->
<div class="leaderboard-overlay" id="leaderboard-overlay" onclick="closeLeaderboard(event)">
    <div class="leaderboard-modal" onclick="event.stopPropagation()">
        <div class="leaderboard-header">
            <h2>ğŸ† í•˜íŠ¸ ë­í‚¹</h2>
            <p>ê°€ì¥ ë§ì€ ì‚¬ë‘ì„ ë°›ì€ ê³¡</p>
        </div>
        <div class="leaderboard-content" id="leaderboard-content">
            <div class="leaderboard-empty">ì•„ì§ í•˜íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        </div>
        <button class="leaderboard-close" onclick="closeLeaderboard()">ë‹«ê¸°</button>
    </div>
</div>

<!-- ì „ì²´ ì±„íŒ… ëª¨ë‹¬ -->
<div class="all-chat-overlay" id="all-chat-overlay" onclick="closeAllChat(event)">
    <div class="all-chat-modal" onclick="event.stopPropagation()">
        <div class="all-chat-header">
            <div>
                <h2>ğŸ“œ ì „ì²´ ì±„íŒ… ê¸°ë¡</h2>
                <div class="all-chat-header-info" id="all-chat-count">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
            <button class="chat-close-btn" onclick="closeAllChat()">Ã—</button>
        </div>
        <div class="all-chat-messages" id="all-chat-messages">
            <div class="all-chat-loading">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
        <button class="all-chat-close" onclick="closeAllChat()">ë‹«ê¸°</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAc3yxKWbhe2wXo2yXJTTRsHC7lfICPlvY",
        authDomain: "ignition-f1bbe.firebaseapp.com",
        databaseURL: "https://ignition-f1bbe-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "ignition-f1bbe",
        storageBucket: "ignition-f1bbe.firebasestorage.app",
        messagingSenderId: "683379402225",
        appId: "1:683379402225:web:43175ebf42a1842e559050"
    };

    const ADMIN_PASSWORD = "2026";
    const RESET_PASSWORD = "1026";

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let currentTeam = '';
    let currentSong = '';
    let isAdmin = false;
    let interactionEnabled = false; // ê´€ê° ì°¸ì—¬ ê¸°ëŠ¥ í™œì„±í™” ì—¬ë¶€ (í•˜íŠ¸, ì±„íŒ…, ì¶”ì²¨)

    // ì…‹ë¦¬ìŠ¤íŠ¸ ë°ì´í„°
    const playlist = [
        {
            team: "í”¼ë²„ìŠ¤ Phoebus",
            members: [
                { part: "Vocal", names: "ë°©ì¤€í˜ ìš°ì§€ì„± ë°•í•œìŒ" },
                { part: "Guitar", names: "ê¹€ì„¸ì§„ ê¹€ì•„ì¸ ê¹€ìœ ë¦¬ ì˜¤ë¯¼í˜¸" },
                { part: "Keyboard", names: "ë°±ë‹¤ì¸" },
                { part: "Bass", names: "ê¹€ë‚¨íœ˜ ê¹€ì¬ì„ ë°•ì§„ì› ìµœì›í˜¸" },
                { part: "Drum", names: "ê¹€ë™ìš± ê°•í™”ìœ¤ ì´ë„í—Œ" }
            ],
            songs: ["ë¹¨ê°„ í”¼í„°", "wish", "KIDS", "ìš°ë¦¬ì˜ ë°¤ì€ ë‹¹ì‹ ì˜ ë‚®ë³´ë‹¤ ì•„ë¦„ë‹µë‹¤", "rengoku.", "ë‹´ë°°ê°€ê²Œ ì•„ê°€ì”¨"]
        },
        {
            team: "í”¼í„°ìŠ¤ì•¤ì§„ìŠ¤ Peters and Jeans",
            members: [
                { part: "Vocal", names: "ë°•ì‹œí˜„" },
                { part: "Guitar", names: "ë°•ì§€ì›" },
                { part: "Keyboard", names: "ë°•ë¯¼ì„" },
                { part: "Bass", names: "í•œì§€ìš°" },
                { part: "Drum", names: "ì•ˆìŠ¹í™˜" }
            ],
            songs: ["Drive It Like You Stole It", "Cigarettes & Alcohol", "ê³ì—", "ì—°ëª»", "Radio", "Supernatural"]
        },
        {
            team: "íˆí¬ë£¨ Hipporu",
            members: [
                { part: "Vocal", names: "ì´í•´ì¸" },
                { part: "Guitar", names: "í•œì¬ë¯¼ ì¥ì¬ìœ¤" },
                { part: "Keyboard", names: "ë°•ì´ë‘" },
                { part: "Bass", names: "ì •ì„œí˜„" },
                { part: "Drum", names: "ì—„ì§€í›ˆ" }
            ],
            songs: ["Last Day", "ìƒˆë²½ë³„", "ì˜¤ë¦¬ë‚ ë‹¤", "Blue Bird", "ë„¤ë²„ì—”ë”©ìŠ¤í† ë¦¬", "ëª½ìœ ë³‘"]
        },
        {
            team: "ì¸ìŠ¤í˜ì´ì¦ˆ In Spades",
            members: [
                { part: "Vocal", names: "ë°°ì§€ì› ê³ ì¤€ì˜" },
                { part: "Guitar", names: "í•œì„±ë¯¼ í™ì§€í˜¸" },
                { part: "Bass", names: "í™©ìˆ˜ì •" },
                { part: "Drum", names: "ì†¡í•˜ë¯¼" }
            ],
            songs: ["í­í¬", "Michael", "ì•…ì–´ëª¨ì", "ë¬´ë¦¬ë¬´ë¦¬!", "ë…¹ìŠ¬ì§€ ì•Šì„ ë‚ ", "Not a Dream"]
        }
    ];

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì…‹ë¦¬ìŠ¤íŠ¸ ìƒì„±
    function generateSetlist() {
        const setlistDiv = document.getElementById('setlist');
        setlistDiv.innerHTML = '';

        playlist.forEach(item => {
            const block = document.createElement('div');
            block.className = 'team-block';
            block.dataset.team = item.team;

            let songsHTML = '';
            item.songs.forEach((song, index) => {
                const songId = generateSongId(item.team, song);
                songsHTML += `
                    <div class="song-item" data-team="${item.team}" data-song="${song}" data-song-id="${songId}" onclick="handleSongClick('${item.team}', '${song.replace(/'/g, "\\'")}')">
                        <div class="song-number">${index + 1}</div>
                        <div class="song-title">${song}</div>
                        <div class="playing-icon">ğŸµ</div>
                        <button class="heart-btn" onclick="event.stopPropagation(); addHeart('${songId}', this)">
                            â¤ï¸ <span class="heart-count" id="heart-${songId}">0</span>
                        </button>
                    </div>
                `;
            });

            block.innerHTML = `
                <div class="team-header">
                    <span class="team-name">${item.team}</span>
                    <span class="team-badge">NOW</span>
                </div>
                <div class="team-members">
                    ${item.members.map(m => {
                        const nameList = m.names.split(' ');
                        const formatted = nameList.length >= 3
                            ? nameList.map((n, i) => (i > 0 && i % 2 === 0) ? '<br>' + n : n).join(' ').replace(/ <br>/g, '<br>')
                            : m.names;
                        return `<div class="member-item"><span class="part">${m.part}</span><span class="names">${formatted}</span></div>`;
                    }).join('')}
                </div>
                <div class="song-list">${songsHTML}</div>
            `;

            setlistDiv.appendChild(block);
        });
    }

    // ê³¡ í´ë¦­ í•¸ë“¤ëŸ¬ (ê´€ë¦¬ìë§Œ)
    function handleSongClick(team, song) {
        if (isAdmin) {
            updateLive(team, song);
        }
    }

    // Firebase ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ê°ì‹œ
    let lastSongChangeTime = 0;
    database.ref('liveStatus').on('value', (snapshot) => {
        const data = snapshot.val();
        const prevSong = currentSong;
        const prevTeam = currentTeam;

        if (data) {
            currentTeam = data.team || '';
            currentSong = data.song || '';

            // íŒ€ì´ ë°”ë€Œë©´ í•´ë‹¹ íŒ€ì˜ ì—´ê¸° ê²Œì´ì§€ ë¡œë“œ
            if (currentTeam && currentTeam !== prevTeam && currentTeam !== 'ğŸ‰') {
                loadTeamHypeCount(currentTeam);
            }

            // ê³¡ì´ ë³€ê²½ë˜ì—ˆê³ , ìƒˆë¡œìš´ ê³¡ì´ ìˆì„ ë•Œ ì±„íŒ…ì— ì•Œë¦¼
            const now = Date.now();
            if (data.updatedAt && data.updatedAt > lastSongChangeTime && currentSong && currentSong !== prevSong) {
                lastSongChangeTime = data.updatedAt;
                // ê³µì—° ì¢…ë£Œê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì•Œë¦¼
                if (currentTeam !== 'ğŸ‰') {
                    addSongChangeNotice(currentTeam, currentSong);
                }
            }
        } else {
            currentTeam = '';
            currentSong = '';
        }
        updateDisplay();
        updateHypeButtonState(); // íŒ€ ë³€ê²½ ì‹œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    });

    // í™”ë©´ ì—…ë°ì´íŠ¸
    function updateDisplay() {
        const nowPlaying = document.getElementById('now-playing');
        const currentTeamEl = document.getElementById('current-team');
        const currentSongEl = document.getElementById('current-song');

        // í˜„ì¬ ì¬ìƒ ì¤‘ í‘œì‹œ
        if (currentTeam && currentSong && currentTeam !== 'ğŸ‰') {
            nowPlaying.classList.add('visible');
            document.body.classList.add('has-now-playing');
            currentTeamEl.innerText = currentTeam;
            currentSongEl.innerText = currentSong;
        } else if (currentTeam === 'ğŸ‰') {
            nowPlaying.classList.add('visible');
            document.body.classList.add('has-now-playing');
            currentTeamEl.innerText = '';
            currentSongEl.innerText = currentSong;
        } else {
            nowPlaying.classList.remove('visible');
            document.body.classList.remove('has-now-playing');
        }

        // ëª¨ë“  ê³¡ ì´ˆê¸°í™”
        document.querySelectorAll('.song-item').forEach(item => {
            item.classList.remove('active');
        });
        document.querySelectorAll('.team-block').forEach(block => {
            block.classList.remove('has-active');
        });

        // í˜„ì¬ ê³¡ ê°•ì¡°
        if (currentTeam && currentSong) {
            const activeItem = document.querySelector(`.song-item[data-team="${currentTeam}"][data-song="${currentSong}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
                activeItem.closest('.team-block').classList.add('has-active');

                // í˜„ì¬ ê³¡ìœ¼ë¡œ ìŠ¤í¬ë¡¤ (ë¶€ë“œëŸ½ê²Œ)
                activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    }

    // URL íŒŒë¼ë¯¸í„° í™•ì¸
    const urlParams = new URLSearchParams(window.location.search);
    const isAdminMode = urlParams.has('admin');

    if (isAdminMode) {
        document.getElementById('password-section').style.display = 'block';
        document.getElementById('admin-password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') checkPassword();
        });
    }

    // ë¹„ë°€ë²ˆí˜¸ í™•ì¸
    function checkPassword() {
        const input = document.getElementById('admin-password').value;
        const errorMsg = document.getElementById('error-msg');

        if (input === ADMIN_PASSWORD) {
            isAdmin = true;
            document.getElementById('password-section').style.display = 'none';
            document.getElementById('admin-controls').classList.add('visible');
            document.getElementById('setlist').classList.add('admin-mode');
        } else {
            errorMsg.style.display = 'block';
            document.getElementById('admin-password').value = '';
            setTimeout(() => { errorMsg.style.display = 'none'; }, 2000);
        }
    }

    // Firebase ì—…ë°ì´íŠ¸
    function updateLive(teamName, songName) {
        database.ref('liveStatus').set({
            team: teamName,
            song: songName,
            updatedAt: Date.now()
        });
    }

    // ê³¡ ID ìƒì„± (Firebase í‚¤ë¡œ ì‚¬ìš©)
    function generateSongId(team, song) {
        return btoa(encodeURIComponent(team + '_' + song)).replace(/[^a-zA-Z0-9]/g, '');
    }

    // í•˜íŠ¸ ë¡œì»¬ ë²„í¼ (ë””ë°”ìš´ì‹±ìš©)
    const heartBuffer = {};
    const localHeartCounts = {};
    let flushTimeout = null;

    // í•˜íŠ¸ ì¶”ê°€ (ìµœì í™” ë²„ì „)
    function addHeart(songId, btnElement) {
        // ì°¸ì—¬ ê¸°ëŠ¥ì´ ë‹«í˜€ìˆìœ¼ë©´ ë¬´ì‹œ
        if (!interactionEnabled) return;

        // ë²„íŠ¼ ì• ë‹ˆë©”ì´ì…˜
        btnElement.classList.add('clicked');
        setTimeout(() => btnElement.classList.remove('clicked'), 300);

        // í”Œë¡œíŒ… í•˜íŠ¸ íš¨ê³¼
        createFloatingHeart(btnElement);

        // ë¡œì»¬ ì¹´ìš´íŠ¸ ì¦‰ì‹œ ì¦ê°€ (UI ë°˜ì‘ì„±)
        localHeartCounts[songId] = (localHeartCounts[songId] || 0) + 1;
        updateHeartDisplay(songId);

        // ë²„í¼ì— ì¶”ê°€
        heartBuffer[songId] = (heartBuffer[songId] || 0) + 1;

        // ë””ë°”ìš´ì‹±: 500ms í›„ì— í•œë²ˆì— ì „ì†¡
        clearTimeout(flushTimeout);
        flushTimeout = setTimeout(flushHearts, 500);
    }

    // ë²„í¼ëœ í•˜íŠ¸ë¥¼ Firebaseì— ì „ì†¡
    function flushHearts() {
        const updates = {};
        Object.keys(heartBuffer).forEach(songId => {
            if (heartBuffer[songId] > 0) {
                // ê° ê³¡ë³„ë¡œ transaction
                const count = heartBuffer[songId];
                database.ref('hearts/' + songId).transaction(current => (current || 0) + count);
            }
        });
        // ë²„í¼ ì´ˆê¸°í™”
        Object.keys(heartBuffer).forEach(k => heartBuffer[k] = 0);
    }

    // í•˜íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸
    function updateHeartDisplay(songId) {
        const countEl = document.getElementById('heart-' + songId);
        if (countEl) {
            const count = localHeartCounts[songId] || 0;
            countEl.innerText = count >= 1000 ? (count / 1000).toFixed(1) + 'k' : count;
        }
    }

    // í”Œë¡œíŒ… í•˜íŠ¸ ìƒì„±
    function createFloatingHeart(btnElement) {
        const rect = btnElement.getBoundingClientRect();
        const heart = document.createElement('div');
        heart.className = 'floating-heart';
        heart.innerText = 'â¤ï¸';
        heart.style.left = rect.left + rect.width / 2 - 12 + 'px';
        heart.style.top = rect.top + 'px';
        document.body.appendChild(heart);
        setTimeout(() => heart.remove(), 1000);
    }

    // í•˜íŠ¸ ìˆ˜ ì‹¤ì‹œê°„ ê°ì‹œ (ê³¡ë³„ë¡œ ê°œë³„ ë¦¬ìŠ¤ë„ˆ - ìµœì í™”)
    function setupHeartListeners() {
        playlist.forEach(item => {
            item.songs.forEach(song => {
                const songId = generateSongId(item.team, song);
                database.ref('hearts/' + songId).on('value', (snapshot) => {
                    const serverCount = snapshot.val() || 0;
                    // ì„œë²„ ê°’ì´ ë¡œì»¬ë³´ë‹¤ í¬ë©´ ì„œë²„ ê°’ ì‚¬ìš© (ë‹¤ë¥¸ ì‚¬ìš©ìì˜ í•˜íŠ¸ ë°˜ì˜)
                    if (serverCount > (localHeartCounts[songId] || 0)) {
                        localHeartCounts[songId] = serverCount;
                        updateHeartDisplay(songId);
                    }
                });
            });
        });
    }

    // í•˜íŠ¸ ì „ì²´ ì´ˆê¸°í™”
    function resetHearts() {
        const inputPw = prompt('í•˜íŠ¸ ì´ˆê¸°í™” ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
        if (inputPw === RESET_PASSWORD) {
            if (confirm('ì •ë§ ëª¨ë“  í•˜íŠ¸ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                // ë²„í¼ì— ë‚¨ì•„ìˆëŠ” í•˜íŠ¸ ì „ì†¡ ì·¨ì†Œ
                clearTimeout(flushTimeout);
                Object.keys(heartBuffer).forEach(k => heartBuffer[k] = 0);

                // Firebase ì‚­ì œ
                database.ref('hearts').remove();

                // ë¡œì»¬ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
                Object.keys(localHeartCounts).forEach(k => localHeartCounts[k] = 0);
                document.querySelectorAll('.heart-count').forEach(el => el.innerText = '0');
                alert('í•˜íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        } else if (inputPw !== null) {
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
        }
    }

    // ë¦¬ë”ë³´ë“œ ì—´ê¸°
    function openLeaderboard() {
        updateLeaderboard();
        document.getElementById('leaderboard-overlay').classList.add('visible');
    }

    // ë¦¬ë”ë³´ë“œ ë‹«ê¸°
    function closeLeaderboard(event) {
        if (!event || event.target === event.currentTarget) {
            document.getElementById('leaderboard-overlay').classList.remove('visible');
        }
    }

    // ê³¡ ì •ë³´ ì°¾ê¸°
    function findSongInfo(songId) {
        for (const team of playlist) {
            for (const song of team.songs) {
                if (generateSongId(team.team, song) === songId) {
                    return { song, team: team.team.split(' ')[0] }; // íŒ€ëª… ì²« ë‹¨ì–´ë§Œ
                }
            }
        }
        return null;
    }

    // ë¦¬ë”ë³´ë“œ ì—…ë°ì´íŠ¸
    function updateLeaderboard() {
        const content = document.getElementById('leaderboard-content');

        // ëª¨ë“  ê³¡ì˜ í•˜íŠ¸ ìˆ˜ ìˆ˜ì§‘
        const songs = [];
        playlist.forEach(team => {
            team.songs.forEach(song => {
                const songId = generateSongId(team.team, song);
                const hearts = localHeartCounts[songId] || 0;
                if (hearts > 0) {
                    songs.push({
                        songId,
                        song,
                        team: team.team.split(' ')[0],
                        hearts
                    });
                }
            });
        });

        // í•˜íŠ¸ ìˆ˜ë¡œ ì •ë ¬
        songs.sort((a, b) => b.hearts - a.hearts);

        if (songs.length === 0) {
            content.innerHTML = '<div class="leaderboard-empty">ì•„ì§ í•˜íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            return;
        }

        // TOP 10ë§Œ í‘œì‹œ
        const top10 = songs.slice(0, 10);
        content.innerHTML = top10.map((item, index) => {
            const rankClass = index < 3 ? `rank-${index + 1}` : '';
            const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : '';
            return `
                <div class="leaderboard-item ${rankClass}">
                    <div class="leaderboard-rank">${medal || (index + 1)}</div>
                    <div class="leaderboard-info">
                        <div class="leaderboard-song">${item.song}</div>
                        <div class="leaderboard-team">${item.team}</div>
                    </div>
                    <div class="leaderboard-hearts">â¤ï¸ ${item.hearts >= 1000 ? (item.hearts/1000).toFixed(1) + 'k' : item.hearts}</div>
                </div>
            `;
        }).join('');
    }

    // ========== ì¶”ì²¨ ê¸°ëŠ¥ ==========
    let myRaffleNumber = localStorage.getItem('ignition_raffle_number');
    let raffleParticipants = {};

    // ì¶”ì²¨ ëª¨ë‹¬ ì—´ê¸°
    function openRaffle() {
        updateRaffleUI();
        document.getElementById('raffle-overlay').classList.add('visible');
        // ê´€ë¦¬ìë©´ ê´€ë¦¬ì íŒ¨ë„ í‘œì‹œ
        if (isAdmin) {
            document.getElementById('raffle-admin').style.display = 'block';
        }
    }

    // ì¶”ì²¨ ëª¨ë‹¬ ë‹«ê¸°
    function closeRaffle(event) {
        if (!event || event.target === event.currentTarget) {
            document.getElementById('raffle-overlay').classList.remove('visible');
        }
    }

    // ì¶”ì²¨ ì°¸ì—¬
    function joinRaffle() {
        // ì°¸ì—¬ ê¸°ëŠ¥ì´ ë‹«í˜€ìˆìœ¼ë©´ ë¬´ì‹œ
        if (!interactionEnabled) {
            alert('ì•„ì§ ì¶”ì²¨ì— ì°¸ì—¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        if (myRaffleNumber) return; // ì´ë¯¸ ì°¸ì—¬í•¨

        // ìƒˆ ë²ˆí˜¸ ë°œê¸‰ (001~999)
        database.ref('raffle/nextNumber').transaction(current => {
            return (current || 0) + 1;
        }, (error, committed, snapshot) => {
            if (committed) {
                const number = snapshot.val();
                const paddedNumber = String(number).padStart(3, '0');
                myRaffleNumber = paddedNumber;
                localStorage.setItem('ignition_raffle_number', paddedNumber);

                // Firebaseì— ì°¸ì—¬ì ë“±ë¡
                database.ref('raffle/participants/' + paddedNumber).set({
                    joinedAt: Date.now()
                });

                updateRaffleUI();
            }
        });
    }

    // ì¶”ì²¨ UI ì—…ë°ì´íŠ¸
    function updateRaffleUI() {
        const fab = document.getElementById('raffle-fab');
        const header = document.getElementById('raffle-header');
        const status = document.getElementById('raffle-status');
        const numberEl = document.getElementById('raffle-number');
        const joinBtn = document.getElementById('raffle-join-btn');
        const countEl = document.getElementById('raffle-participant-count');

        if (myRaffleNumber) {
            fab.classList.add('joined');
            fab.innerText = 'âœ“';
            header.classList.add('joined');
            header.querySelector('h2').innerText = 'ğŸŸï¸ ì°¸ì—¬ ì™„ë£Œ!';
            header.querySelector('p').innerText = 'ë‹¹ì²¨ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”';
            status.innerText = 'ë‚´ ë²ˆí˜¸';
            numberEl.innerText = myRaffleNumber;
            joinBtn.disabled = true;
            joinBtn.classList.remove('interaction-disabled');
            joinBtn.innerText = 'ì°¸ì—¬ ì™„ë£Œ!';
        } else if (!interactionEnabled) {
            // ì°¸ì—¬ ê¸°ëŠ¥ì´ ë‹«í˜€ìˆëŠ” ê²½ìš°
            fab.classList.remove('joined');
            fab.innerText = 'ğŸŸï¸';
            header.classList.remove('joined');
            status.innerText = '';
            numberEl.innerText = '-';
            joinBtn.disabled = true;
            joinBtn.classList.add('interaction-disabled');
            joinBtn.innerText = '16:30ë¶€í„° ì¶”ì²¨ ì°¸ì—¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤';
        } else {
            fab.classList.remove('joined');
            fab.innerText = 'ğŸŸï¸';
            header.classList.remove('joined');
            status.innerText = 'ì°¸ì—¬í•˜ë©´ ë²ˆí˜¸ë¥¼ ë°›ì•„ìš”';
            numberEl.innerText = '-';
            joinBtn.disabled = false;
            joinBtn.classList.remove('interaction-disabled');
            joinBtn.innerText = 'ì¶”ì²¨ ì°¸ì—¬í•˜ê¸°';
        }

        // ì°¸ì—¬ì ìˆ˜ í‘œì‹œ
        const count = Object.keys(raffleParticipants).length;
        countEl.innerText = `í˜„ì¬ ì°¸ì—¬ì: ${count}ëª…`;

        // ê´€ë¦¬ì ì»¨íŠ¸ë¡¤ì˜ ì°¸ì—¬ì ìˆ˜ë„ ì—…ë°ì´íŠ¸
        const adminCountEl = document.getElementById('admin-raffle-count');
        if (adminCountEl) {
            adminCountEl.innerText = `(${count}ëª… ì°¸ì—¬ì¤‘)`;
        }
    }

    // ì°¸ì—¬ì ì‹¤ì‹œê°„ ê°ì‹œ
    database.ref('raffle/participants').on('value', (snapshot) => {
        raffleParticipants = snapshot.val() || {};
        updateRaffleUI();
    });

    // ë‹¹ì²¨ì ì¶”ì²¨ (ê´€ë¦¬ì)
    function drawWinner() {
        const numbers = Object.keys(raffleParticipants);
        if (numbers.length === 0) {
            alert('ì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // ëœë¤ ì¶”ì²¨
        const winnerIndex = Math.floor(Math.random() * numbers.length);
        const winnerNumber = numbers[winnerIndex];

        // Firebaseì— ë‹¹ì²¨ ë²ˆí˜¸ ì €ì¥ (ëª¨ë“  ì ‘ì†ìì—ê²Œ ì•Œë¦¼)
        database.ref('raffle/winner').set({
            number: winnerNumber,
            drawnAt: Date.now()
        });
    }

    // ë‹¹ì²¨ ê²°ê³¼ ê°ì‹œ
    database.ref('raffle/winner').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data && data.number) {
            showWinner(data.number);
        }
    });

    // ë‹¹ì²¨ ê²°ê³¼ í‘œì‹œ
    function showWinner(number) {
        const winnerModal = document.querySelector('.winner-modal');
        const winnerIcon = document.getElementById('winner-icon');
        const myNumberDisplay = document.getElementById('my-number-display');
        const winnerResult = document.getElementById('winner-result');

        // ë‹¹ì²¨ ë²ˆí˜¸ í‘œì‹œ
        document.getElementById('winner-number').innerText = number;

        // ë‚´ ë²ˆí˜¸ í‘œì‹œ
        if (myRaffleNumber) {
            myNumberDisplay.innerText = myRaffleNumber;

            // ë‹¹ì²¨ ì—¬ë¶€ í™•ì¸
            if (myRaffleNumber === number) {
                winnerModal.classList.add('is-winner');
                winnerIcon.innerText = 'ğŸ‰';
                winnerResult.className = 'winner-result is-winner';
                winnerResult.innerText = 'ğŸŠ ì¶•í•˜í•©ë‹ˆë‹¤! ë‹¹ì²¨ë˜ì…¨ìŠµë‹ˆë‹¤! ğŸŠ';
            } else {
                winnerModal.classList.remove('is-winner');
                winnerIcon.innerText = 'ğŸŠ';
                winnerResult.className = 'winner-result';
                winnerResult.innerText = '';
            }
        } else {
            myNumberDisplay.innerText = 'ë¯¸ì°¸ì—¬';
            winnerModal.classList.remove('is-winner');
            winnerIcon.innerText = 'ğŸŠ';
            winnerResult.className = 'winner-result';
            winnerResult.innerText = '';
        }

        document.getElementById('winner-overlay').classList.add('visible');
        closeRaffle();
    }

    // ë‹¹ì²¨ ëª¨ë‹¬ ë‹«ê¸°
    function closeWinner() {
        document.getElementById('winner-overlay').classList.remove('visible');
        // ë‹¤ìŒ ì¶”ì²¨ì„ ìœ„í•´ ìƒíƒœ ì´ˆê¸°í™”
        document.querySelector('.winner-modal').classList.remove('is-winner');
    }

    // ì°¸ì—¬ì ì´ˆê¸°í™” (ê´€ë¦¬ì)
    function resetRaffle() {
        const inputPw = prompt('ì°¸ì—¬ì ì´ˆê¸°í™” ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
        if (inputPw === RESET_PASSWORD) {
            if (confirm('ëª¨ë“  ì°¸ì—¬ìë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                database.ref('raffle').remove();
                localStorage.removeItem('ignition_raffle_number');
                myRaffleNumber = null;
                updateRaffleUI();
                alert('ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        } else if (inputPw !== null) {
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
        }
    }

    // ========== ì±„íŒ… ê¸°ëŠ¥ ==========
    let chatMessages = [];
    let lastReadTimestamp = parseInt(localStorage.getItem('ignition_chat_last_read') || '0');
    let chatCooldown = false;
    let myChatId = localStorage.getItem('ignition_chat_id');
    let isChatOpen = false;
    let chatEnabled = true;
    let chatVisible = true;

    // ê³ ìœ  ì±„íŒ… ID ìƒì„± (ì²˜ìŒ í•œë²ˆë§Œ)
    if (!myChatId) {
        myChatId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('ignition_chat_id', myChatId);
    }

    // ì±„íŒ… í™œì„±í™” ìƒíƒœ ê°ì‹œ
    database.ref('chatEnabled').on('value', (snapshot) => {
        chatEnabled = snapshot.val() !== false; // ê¸°ë³¸ê°’ true
        updateChatEnabledUI();
    });

    // ì±„íŒ… í‘œì‹œ ìƒíƒœ ê°ì‹œ
    database.ref('chatVisible').on('value', (snapshot) => {
        chatVisible = snapshot.val() !== false; // ê¸°ë³¸ê°’ true
        updateChatVisibleUI();
    });

    // ì±„íŒ… í™œì„±í™” UI ì—…ë°ì´íŠ¸
    function updateChatEnabledUI() {
        const input = document.getElementById('chat-input');
        const sendBtn = document.getElementById('chat-send-btn');
        const statusEl = document.getElementById('admin-chat-status');
        const toggleBtn = document.getElementById('chat-toggle-btn');

        // ì°¸ì—¬ ê¸°ëŠ¥ì´ ë‹«í˜€ìˆìœ¼ë©´ ì±„íŒ…ë„ ë¹„í™œì„±í™”
        if (!interactionEnabled) {
            input.disabled = true;
            input.placeholder = '16:30ì— ì±„íŒ…ì°½ì´ ì—´ë¦½ë‹ˆë‹¤.';
            sendBtn.disabled = true;
        } else if (chatEnabled) {
            input.disabled = false;
            input.placeholder = 'ë©”ì‹œì§€ ì…ë ¥ (ìµœëŒ€ 30ì)';
            if (!chatCooldown) sendBtn.disabled = false;
        } else {
            input.disabled = true;
            input.placeholder = 'ì±„íŒ…ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤';
            sendBtn.disabled = true;
        }

        // ê´€ë¦¬ì íŒ¨ë„ ìƒíƒœ í‘œì‹œ
        if (statusEl) statusEl.innerText = chatEnabled ? '(í™œì„±í™”)' : '(ë¹„í™œì„±í™”)';
        if (statusEl) statusEl.style.color = chatEnabled ? '#27ae60' : '#e74c3c';
        if (toggleBtn) toggleBtn.innerText = chatEnabled ? 'ğŸ”’ ì±„íŒ… ë¹„í™œì„±í™”' : 'ğŸ”“ ì±„íŒ… í™œì„±í™”';
    }

    // ì±„íŒ… í™œì„±í™”/ë¹„í™œì„±í™” í† ê¸€ (ê´€ë¦¬ì)
    function toggleChatEnabled() {
        const inputPw = prompt('ì±„íŒ… ê´€ë¦¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
        if (inputPw === RESET_PASSWORD) {
            const newState = !chatEnabled;
            database.ref('chatEnabled').set(newState);
            alert(newState ? 'ì±„íŒ…ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì±„íŒ…ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else if (inputPw !== null) {
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
        }
    }

    // ì±„íŒ… í‘œì‹œ/ìˆ¨ê¹€ í† ê¸€ (ê´€ë¦¬ì)
    function toggleChatVisible() {
        const inputPw = prompt('ì±„íŒ… ê´€ë¦¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
        if (inputPw === RESET_PASSWORD) {
            const newState = !chatVisible;
            database.ref('chatVisible').set(newState);
            alert(newState ? 'ì±„íŒ… ì•„ì´ì½˜ì´ í‘œì‹œë©ë‹ˆë‹¤.' : 'ì±„íŒ… ì•„ì´ì½˜ì´ ìˆ¨ê²¨ì§‘ë‹ˆë‹¤.');
        } else if (inputPw !== null) {
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
        }
    }

    // ì±„íŒ… í‘œì‹œ UI ì—…ë°ì´íŠ¸
    function updateChatVisibleUI() {
        const chatFab = document.getElementById('chat-fab');
        const visibleBtn = document.getElementById('chat-visible-btn');

        if (chatVisible) {
            chatFab.style.display = 'flex';
            if (visibleBtn) visibleBtn.innerText = 'ğŸ‘ï¸ ì±„íŒ… ìˆ¨ê¸°ê¸°';
        } else {
            chatFab.style.display = 'none';
            // ì±„íŒ…ì°½ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
            if (isChatOpen) closeChat();
            if (visibleBtn) visibleBtn.innerText = 'ğŸ‘ï¸ ì±„íŒ… ë³´ì´ê¸°';
        }
    }

    // ì±„íŒ… ëª¨ë‹¬ ì—´ê¸°
    function openChat() {
        isChatOpen = true;
        document.getElementById('chat-overlay').classList.add('visible');
        document.getElementById('chat-input').focus();
        // ì½ìŒ ì²˜ë¦¬
        if (chatMessages.length > 0) {
            lastReadTimestamp = chatMessages[chatMessages.length - 1].timestamp;
            localStorage.setItem('ignition_chat_last_read', lastReadTimestamp.toString());
        }
        updateUnreadBadge();
        scrollChatToBottom();
    }

    // ì±„íŒ… ëª¨ë‹¬ ë‹«ê¸°
    function closeChat(event) {
        if (!event || event.target === event.currentTarget) {
            isChatOpen = false;
            document.getElementById('chat-overlay').classList.remove('visible');
        }
    }

    // ê³¡ ë³€ê²½ ì•Œë¦¼ì„ ì±„íŒ…ì— ì¶”ê°€
    function addSongChangeNotice(team, song) {
        // íŒ€ëª…ì—ì„œ ì˜ë¬¸ëª… ì œê±° (ì˜ˆ: "í”¼ë²„ìŠ¤ Phoebus" -> "í”¼ë²„ìŠ¤")
        const teamShort = team.split(' ')[0];
        database.ref('chat').push({
            type: 'notice',
            text: `ğŸµ ${teamShort} - ${song}`,
            timestamp: Date.now()
        });
    }

    // ========== í›„ì› ê¸°ëŠ¥ ==========
    function openDonateModal() {
        document.getElementById('donate-overlay').classList.add('visible');
    }

    function closeDonateModal(event) {
        if (!event || event.target === event.currentTarget) {
            document.getElementById('donate-overlay').classList.remove('visible');
        }
    }

    function sendDonation(amount) {
        // ì±„íŒ…ì— í›„ì› ì•Œë¦¼ ì¶”ê°€
        database.ref('chat').push({
            type: 'donate',
            amount: amount,
            timestamp: Date.now()
        });

        closeDonateModal();
        alert(`${amount.toLocaleString()}ì› í›„ì› ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ’¸`);
    }

    // ì±„íŒ… ì „ì†¡
    function sendChat() {
        // ì°¸ì—¬ ê¸°ëŠ¥ì´ ë‹«í˜€ìˆìœ¼ë©´ ë¬´ì‹œ
        if (!interactionEnabled) {
            alert('ì•„ì§ ì±„íŒ…ì— ì°¸ì—¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        if (!chatEnabled) {
            alert('ì±„íŒ…ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            return;
        }

        const input = document.getElementById('chat-input');
        const message = input.value.trim();

        if (!message || chatCooldown) return;
        if (message.length > 30) {
            alert('ë©”ì‹œì§€ëŠ” 30ìê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            return;
        }

        // Firebaseì— ë©”ì‹œì§€ ì €ì¥
        database.ref('chat').push({
            text: message,
            chatId: myChatId,
            timestamp: Date.now()
        });

        input.value = '';

        // ì¿¨íƒ€ì„ ì‹œì‘ (10ì´ˆ)
        startCooldown();
    }

    // ì—”í„°í‚¤ ì²˜ë¦¬
    function handleChatKeypress(event) {
        if (event.key === 'Enter') {
            sendChat();
        }
    }

    // ì¿¨íƒ€ì„ ì‹œì‘
    function startCooldown() {
        chatCooldown = true;
        const sendBtn = document.getElementById('chat-send-btn');
        const cooldownEl = document.getElementById('chat-cooldown');
        sendBtn.disabled = true;
        cooldownEl.classList.add('visible');

        let remaining = 10;
        cooldownEl.innerText = `${remaining}ì´ˆ í›„ì— ë‹¤ì‹œ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤`;

        const interval = setInterval(() => {
            remaining--;
            if (remaining <= 0) {
                clearInterval(interval);
                chatCooldown = false;
                sendBtn.disabled = false;
                cooldownEl.classList.remove('visible');
            } else {
                cooldownEl.innerText = `${remaining}ì´ˆ í›„ì— ë‹¤ì‹œ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤`;
            }
        }, 1000);
    }

    // ì±„íŒ… ë©”ì‹œì§€ ë Œë”ë§
    function renderChatMessages() {
        const container = document.getElementById('chat-messages');

        // ìˆ¨ê²¨ì§€ì§€ ì•Šì€ ë©”ì‹œì§€ë§Œ í•„í„° (ê´€ë¦¬ìëŠ” ì „ë¶€ ë³¼ ìˆ˜ ìˆìŒ)
        const visibleMessages = isAdmin
            ? chatMessages
            : chatMessages.filter(msg => !msg.hidden);

        if (visibleMessages.length === 0) {
            container.innerHTML = '<div class="chat-empty">ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            return;
        }

        container.innerHTML = visibleMessages.map(msg => {
            // ì‹œìŠ¤í…œ ì•Œë¦¼ (ê³¡ ë³€ê²½)
            if (msg.type === 'notice') {
                return `<div class="chat-system-notice">${escapeHtml(msg.text)}</div>`;
            }

            // í›„ì› ì•Œë¦¼
            if (msg.type === 'donate') {
                return `<div class="chat-donate-notice">ğŸ’¸ ${msg.amount.toLocaleString()}ì› í›„ì›!</div>`;
            }

            const isMine = msg.chatId === myChatId;
            const time = new Date(msg.timestamp);
            const timeStr = time.getHours().toString().padStart(2, '0') + ':' + time.getMinutes().toString().padStart(2, '0');
            const isHidden = msg.hidden;

            // ê´€ë¦¬ìë©´ ìˆ¨ê¹€ ë²„íŠ¼ í‘œì‹œ
            const hideBtn = isAdmin
                ? `<button class="chat-hide-btn" onclick="toggleHideChat('${msg.key}', ${!isHidden})">${isHidden ? 'â†©' : 'Ã—'}</button>`
                : '';

            return `
                <div class="chat-message-wrapper ${isMine ? 'mine' : ''}">
                    ${hideBtn}
                    <div class="chat-message ${isMine ? 'mine' : ''} ${isHidden ? 'hidden' : ''}">
                        <div class="chat-message-text">${escapeHtml(msg.text)}</div>
                        <div class="chat-message-time">${timeStr}</div>
                    </div>
                </div>
            `;
        }).join('');

        scrollChatToBottom();
    }

    // ë©”ì‹œì§€ ìˆ¨ê¹€/ë³µì› í† ê¸€ (ê´€ë¦¬ì)
    function toggleHideChat(msgKey, hide) {
        if (!isAdmin) return;
        database.ref('chat/' + msgKey + '/hidden').set(hide);
    }

    // ì „ì²´ ì±„íŒ… ì—´ê¸°
    function openAllChat() {
        document.getElementById('all-chat-overlay').classList.add('visible');
        loadAllChat();
    }

    // ì „ì²´ ì±„íŒ… ë‹«ê¸°
    function closeAllChat(event) {
        if (!event || event.target === event.currentTarget) {
            document.getElementById('all-chat-overlay').classList.remove('visible');
        }
    }

    // ì „ì²´ ì±„íŒ… ë¶ˆëŸ¬ì˜¤ê¸°
    function loadAllChat() {
        const container = document.getElementById('all-chat-messages');
        const countEl = document.getElementById('all-chat-count');

        container.innerHTML = '<div class="all-chat-loading">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

        database.ref('chat').orderByChild('timestamp').once('value', (snapshot) => {
            const data = snapshot.val();

            if (!data) {
                container.innerHTML = '<div class="all-chat-loading">ì±„íŒ… ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                countEl.innerText = '0ê°œì˜ ë©”ì‹œì§€';
                return;
            }

            const allMessages = Object.entries(data).map(([key, value]) => ({
                ...value,
                key: key
            })).sort((a, b) => a.timestamp - b.timestamp);

            // ê´€ë¦¬ìê°€ ì•„ë‹ˆë©´ ìˆ¨ê²¨ì§„ ë©”ì‹œì§€ í•„í„°
            const visibleMessages = isAdmin
                ? allMessages
                : allMessages.filter(msg => !msg.hidden);

            countEl.innerText = `${visibleMessages.length}ê°œì˜ ë©”ì‹œì§€`;

            if (visibleMessages.length === 0) {
                container.innerHTML = '<div class="all-chat-loading">ì±„íŒ… ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            container.innerHTML = visibleMessages.map(msg => {
                // ì‹œìŠ¤í…œ ì•Œë¦¼
                if (msg.type === 'notice') {
                    return `<div class="chat-system-notice">${escapeHtml(msg.text)}</div>`;
                }

                // í›„ì› ì•Œë¦¼
                if (msg.type === 'donate') {
                    return `<div class="chat-donate-notice">ğŸ’¸ ${msg.amount.toLocaleString()}ì› í›„ì›!</div>`;
                }

                const isMine = msg.chatId === myChatId;
                const time = new Date(msg.timestamp);
                const timeStr = time.getHours().toString().padStart(2, '0') + ':' + time.getMinutes().toString().padStart(2, '0');
                const isHidden = msg.hidden;

                return `
                    <div class="all-chat-item ${isMine ? 'mine' : ''} ${isHidden ? 'hidden-msg' : ''}">
                        <div class="all-chat-text">${escapeHtml(msg.text)}</div>
                        <div class="all-chat-time">${timeStr}${isHidden ? ' (ìˆ¨ê¹€)' : ''}</div>
                    </div>
                `;
            }).join('');

            // ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
            container.scrollTop = container.scrollHeight;
        });
    }

    // ì±„íŒ… ì „ì²´ ì‚­ì œ (ê´€ë¦¬ì)
    function resetChat() {
        const inputPw = prompt('ì±„íŒ… ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
        if (inputPw === RESET_PASSWORD) {
            if (confirm('ëª¨ë“  ì±„íŒ…ì„ ì‚­ì œí• ê¹Œìš”? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                database.ref('chat').remove();
                alert('ì±„íŒ…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        } else if (inputPw !== null) {
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
        }
    }

    // HTML ì´ìŠ¤ì¼€ì´í”„ (XSS ë°©ì§€)
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜ë¡œ
    function scrollChatToBottom() {
        const container = document.getElementById('chat-messages');
        container.scrollTop = container.scrollHeight;
    }

    // ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ë°°ì§€ ì—…ë°ì´íŠ¸
    function updateUnreadBadge() {
        const badge = document.getElementById('unread-badge');
        const unreadCount = chatMessages.filter(msg => msg.timestamp > lastReadTimestamp && msg.chatId !== myChatId).length;

        if (unreadCount > 0 && !isChatOpen) {
            badge.innerText = unreadCount > 9 ? '9+' : unreadCount;
            badge.classList.add('visible');
        } else {
            badge.classList.remove('visible');
        }
    }

    // ì±„íŒ… ì‹¤ì‹œê°„ ê°ì‹œ (ìµœê·¼ 20ê°œë§Œ)
    database.ref('chat').orderByChild('timestamp').limitToLast(20).on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            // keyë¥¼ ë©”ì‹œì§€ì— í¬í•¨ì‹œì¼œì„œ ì €ì¥
            chatMessages = Object.entries(data).map(([key, value]) => ({
                ...value,
                key: key
            })).sort((a, b) => a.timestamp - b.timestamp);
        } else {
            chatMessages = [];
        }
        renderChatMessages();
        updateUnreadBadge();

        // ì±„íŒ…ì°½ ì—´ë ¤ìˆìœ¼ë©´ ì½ìŒ ì²˜ë¦¬
        if (isChatOpen && chatMessages.length > 0) {
            lastReadTimestamp = chatMessages[chatMessages.length - 1].timestamp;
            localStorage.setItem('ignition_chat_last_read', lastReadTimestamp.toString());
        }
    });

    // ========== ì—´ê¸° ê²Œì´ì§€ ê¸°ëŠ¥ ==========
    let hypeCount = 0;
    let hypeTarget = 20; // í…ŒìŠ¤íŠ¸ìš© 20, ì‹¤ì œ 300
    let hypeBuffer = 0;
    let hypeFlushTimeout = null;
    let lastHypeMaxTime = 0; // ë§ˆì§€ë§‰ 100% ë‹¬ì„± ì‹œê°„ (ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€)
    let hypeExplodedTeams = {}; // íŒ€ë³„ í­ë°œ ì—¬ë¶€ ì¶”ì 
    let currentHypeListener = null; // í˜„ì¬ íŒ€ì˜ hypeCount ë¦¬ìŠ¤ë„ˆ

    // ì—´ê¸° ê²Œì´ì§€ ëª©í‘œê°’ ì‹¤ì‹œê°„ ê°ì‹œ
    database.ref('hypeTarget').on('value', (snapshot) => {
        hypeTarget = snapshot.val() || 20;
    });

    // íŒ€ë³„ í­ë°œ ì—¬ë¶€ ì‹¤ì‹œê°„ ê°ì‹œ
    database.ref('hypeExplodedTeams').on('value', (snapshot) => {
        hypeExplodedTeams = snapshot.val() || {};
        updateHypeButtonState();
    });

    // íŒ€ë³„ ì—´ê¸° ê²Œì´ì§€ ë¡œë“œ
    function loadTeamHypeCount(team) {
        // ì´ì „ ë¦¬ìŠ¤ë„ˆ ì œê±°
        if (currentHypeListener) {
            database.ref('hypeCount/' + currentHypeListener).off();
        }
        currentHypeListener = team;

        // ìƒˆ íŒ€ì˜ ê²Œì´ì§€ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        database.ref('hypeCount/' + team).on('value', (snapshot) => {
            hypeCount = snapshot.val() || 0;
            updateHypeUI();

            // 100% ë‹¬ì„± ì‹œ í­ë°œ ì´í™íŠ¸ (í˜„ì¬ íŒ€ì´ ì•„ì§ í­ë°œ ì•ˆ í–ˆì„ ë•Œë§Œ)
            if (hypeCount >= hypeTarget && hypeTarget > 0 && currentTeam && !hypeExplodedTeams[currentTeam]) {
                triggerHypeExplosion();
            }
        });
    }

    // ì—´ê¸° UI ì—…ë°ì´íŠ¸
    function updateHypeUI() {
        const percent = Math.min(100, Math.round((hypeCount / hypeTarget) * 100));
        const percentEl = document.getElementById('hype-percent');
        const fillEl = document.getElementById('hype-fill');

        percentEl.innerText = percent + '%';
        fillEl.style.width = percent + '%';

        // 80% ì´ìƒì¼ ë•Œ ê¸€ë¡œìš° íš¨ê³¼
        if (percent >= 80) {
            fillEl.classList.add('maxed');
        } else {
            fillEl.classList.remove('maxed');
        }

        // ê´€ë¦¬ì ëª©í‘œê°’ í‘œì‹œ ì—…ë°ì´íŠ¸
        const adminTargetEl = document.getElementById('admin-hype-target');
        if (adminTargetEl) {
            adminTargetEl.innerText = `(ëª©í‘œ: ${hypeTarget})`;
        }

        updateHypeButtonState();
    }

    // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ (íŒ€ë³„ í­ë°œ ì™„ë£Œ ì‹œ ë¹„í™œì„±í™”)
    function updateHypeButtonState() {
        const btn = document.getElementById('hype-btn');
        const fillEl = document.getElementById('hype-fill');
        const percentEl = document.getElementById('hype-percent');
        const explosion = document.getElementById('hype-explosion');

        if (currentTeam && hypeExplodedTeams[currentTeam]) {
            // ì´ë¯¸ í­ë°œí•œ íŒ€ - ë²„íŠ¼ ë¹„í™œì„±í™” + 100% ìœ ì§€ + ì˜êµ¬ ê¸€ë¡œìš° íš¨ê³¼
            btn.disabled = true;
            btn.innerHTML = '<span class="fire-icon">âœ“</span><span>ì—´ê¸° MAX ë‹¬ì„±!</span>';
            btn.style.opacity = '0.6';
            fillEl.style.width = '100%';
            percentEl.innerText = '100%';
            fillEl.classList.remove('maxed');
            fillEl.classList.add('maxed-permanent'); // ì˜êµ¬ ê¸€ë¡œìš°
        } else {
            // MAXê°€ ì•„ë‹Œ íŒ€ - ëª¨ë“  ê¸€ë¡œìš° íš¨ê³¼ ì œê±°
            btn.disabled = false;
            btn.innerHTML = '<span class="fire-icon">ğŸ”¥</span><span>ì—´ê¸° ì˜¬ë¦¬ê¸°!</span>';
            btn.style.opacity = '1';
            fillEl.classList.remove('maxed');
            fillEl.classList.remove('maxed-permanent');
            explosion.classList.remove('visible'); // í­ë°œ ì´í™íŠ¸ë„ ì œê±°
        }
    }

    // ì—´ê¸° ê²Œì´ì§€ ì ‘ê¸°/í¼ì¹˜ê¸°
    let hypeGaugeCollapsed = false;
    function toggleHypeGauge() {
        const content = document.getElementById('hype-gauge-content');
        const btn = document.getElementById('hype-toggle-btn');
        hypeGaugeCollapsed = !hypeGaugeCollapsed;
        if (hypeGaugeCollapsed) {
            content.classList.add('collapsed');
            btn.textContent = 'â–¼ í¼ì¹˜ê¸°';
        } else {
            content.classList.remove('collapsed');
            btn.textContent = 'â–² ì ‘ê¸°';
        }
    }

    // ì—´ê¸° ì¶”ê°€ (ê´‘í´ ê°€ëŠ¥)
    function addHype() {
        // ì´ë¯¸ í­ë°œí•œ íŒ€ì´ë©´ ë¬´ì‹œ
        if (currentTeam && hypeExplodedTeams[currentTeam]) return;

        // ë²„íŠ¼ ì• ë‹ˆë©”ì´ì…˜
        const btn = document.getElementById('hype-btn');
        btn.style.transform = 'scale(0.95)';
        setTimeout(() => btn.style.transform = '', 100);

        // ë²„í¼ì— ì¶”ê°€
        hypeBuffer++;

        // ë¡œì»¬ UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (ë°˜ì‘ì„±)
        hypeCount++;
        updateHypeUI();

        // ë””ë°”ìš´ì‹±: 300ms í›„ì— í•œë²ˆì— ì „ì†¡
        clearTimeout(hypeFlushTimeout);
        hypeFlushTimeout = setTimeout(flushHype, 300);
    }

    // ë²„í¼ëœ ì—´ê¸°ë¥¼ Firebaseì— ì „ì†¡ (íŒ€ë³„)
    function flushHype() {
        if (hypeBuffer > 0 && currentTeam) {
            const count = hypeBuffer;
            hypeBuffer = 0;
            database.ref('hypeCount/' + currentTeam).transaction(current => (current || 0) + count);
        }
    }

    // í­ë°œ ì´í™íŠ¸ íŠ¸ë¦¬ê±°
    function triggerHypeExplosion() {
        const now = Date.now();
        // 3ì´ˆ ë‚´ ì¤‘ë³µ ë°©ì§€
        if (now - lastHypeMaxTime < 3000) return;
        if (!currentTeam || hypeExplodedTeams[currentTeam]) return;
        lastHypeMaxTime = now;

        // í•´ë‹¹ íŒ€ í­ë°œ ì™„ë£Œ ê¸°ë¡
        database.ref('hypeExplodedTeams/' + currentTeam).set(true);

        // í­ë°œ ì´í™íŠ¸ í‘œì‹œ
        const explosion = document.getElementById('hype-explosion');
        explosion.classList.add('visible');

        // 300ì´ˆ í›„ ìˆ¨ê¹€ (ë¦¬ì…‹ì€ í•˜ì§€ ì•ŠìŒ - íŒ€ë³„ í•œ ë²ˆì´ë¯€ë¡œ)
        setTimeout(() => {
            explosion.classList.remove('visible');
        }, 300000);

        // ì±„íŒ…ì— MAX ì•Œë¦¼ (íŒ€ëª… í¬í•¨)
        const teamShort = currentTeam.split(' ')[0];
        database.ref('chat').push({
            type: 'notice',
            text: `ğŸ”¥ğŸ”¥ğŸ”¥ ${teamShort} ì—´ê¸° MAX! ğŸ”¥ğŸ”¥ğŸ”¥`,
            timestamp: Date.now()
        });
    }

    // ê´€ë¦¬ì: ì—´ê¸° ëª©í‘œê°’ ì„¤ì •
    function setHypeTarget() {
        const inputPw = prompt('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
        if (inputPw === RESET_PASSWORD) {
            const newTarget = prompt('ìƒˆë¡œìš´ ëª©í‘œê°’ì„ ì…ë ¥í•˜ì„¸ìš” (í˜„ì¬: ' + hypeTarget + '):', hypeTarget);
            if (newTarget && !isNaN(parseInt(newTarget)) && parseInt(newTarget) > 0) {
                database.ref('hypeTarget').set(parseInt(newTarget));
                alert('ëª©í‘œê°’ì´ ' + newTarget + '(ìœ¼)ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        } else if (inputPw !== null) {
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
        }
    }

    // ê´€ë¦¬ì: íŒ€ë³„ í­ë°œ ê¸°ë¡ ì´ˆê¸°í™”
    function resetHypeExploded() {
        const inputPw = prompt('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
        if (inputPw === RESET_PASSWORD) {
            if (confirm('ëª¨ë“  íŒ€ì˜ í­ë°œ ê¸°ë¡ê³¼ ê²Œì´ì§€ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”? ê° íŒ€ì´ ë‹¤ì‹œ ì—´ê¸° MAXë¥¼ ë‹¬ì„±í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.')) {
                database.ref('hypeExplodedTeams').remove();
                database.ref('hypeCount').remove(); // íŒ€ë³„ ê²Œì´ì§€ ëª¨ë‘ ì‚­ì œ
                // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                hypeCount = 0;
                hypeExplodedTeams = {};
                updateHypeUI();
                updateHypeButtonState();
                alert('íŒ€ë³„ í­ë°œ ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        } else if (inputPw !== null) {
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
        }
    }

    // ê´€ë¦¬ì: ë¶ˆë„ê¸° (í­ë°œ ì´í™íŠ¸ + ê¸€ë¡œìš° ì œê±°)
    function turnOffExplosion() {
        // í­ë°œ ì´í™íŠ¸ ì¦‰ì‹œ ì œê±°
        document.getElementById('hype-explosion').classList.remove('visible');
        // ê¸€ë¡œìš° íš¨ê³¼ ì œê±°
        const fillEl = document.getElementById('hype-fill');
        fillEl.classList.remove('maxed');
        fillEl.classList.remove('maxed-permanent');
    }

    // ê´€ë¦¬ì: ë¶ˆì§€ë¥´ê¸° (ìˆ˜ë™ í­ë°œ ì´í™íŠ¸)
    function triggerManualExplosion() {
        // í­ë°œ ì´í™íŠ¸ í‘œì‹œ
        const explosion = document.getElementById('hype-explosion');
        explosion.classList.add('visible');

        // ê¸€ë¡œìš° íš¨ê³¼ ì¶”ê°€
        const fillEl = document.getElementById('hype-fill');
        fillEl.classList.add('maxed-permanent');
    }

    // ========== ê´€ê° ì°¸ì—¬ ê¸°ëŠ¥ ì¼ê´„ ê´€ë¦¬ ==========
    // ê´€ê° ì°¸ì—¬ ê¸°ëŠ¥ ìƒíƒœ ê°ì‹œ
    database.ref('interactionEnabled').on('value', (snapshot) => {
        interactionEnabled = snapshot.val() === true; // ê¸°ë³¸ê°’ false (ë‹«í˜)
        updateInteractionUI();
    });

    // ê´€ê° ì°¸ì—¬ ê¸°ëŠ¥ ì—´ê¸°/ë‹«ê¸° (ê´€ë¦¬ì)
    function setInteractionEnabled(enabled) {
        database.ref('interactionEnabled').set(enabled);
    }

    // ê´€ê° ì°¸ì—¬ ê¸°ëŠ¥ UI ì—…ë°ì´íŠ¸
    function updateInteractionUI() {
        // ê´€ë¦¬ì íŒ¨ë„ ìƒíƒœ í‘œì‹œ
        const statusEl = document.getElementById('interaction-status');
        if (statusEl) {
            if (interactionEnabled) {
                statusEl.innerText = 'í˜„ì¬: ì—´ë¦¼ ğŸ”“';
                statusEl.style.color = '#27ae60';
            } else {
                statusEl.innerText = 'í˜„ì¬: ë‹«í˜ ğŸ”’';
                statusEl.style.color = '#e74c3c';
            }
        }

        // í•˜íŠ¸ ë²„íŠ¼ ìƒíƒœ
        updateHeartButtonsState();

        // ì±„íŒ… ìƒíƒœ
        updateChatInteractionState();

        // ì¶”ì²¨ ì°¸ì—¬ ë²„íŠ¼ ìƒíƒœ
        updateRaffleInteractionState();
    }

    // í•˜íŠ¸ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateHeartButtonsState() {
        const heartBtns = document.querySelectorAll('.heart-btn');
        heartBtns.forEach(btn => {
            if (interactionEnabled) {
                btn.classList.remove('disabled');
            } else {
                btn.classList.add('disabled');
            }
        });
    }

    // ì±„íŒ… ì°¸ì—¬ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateChatInteractionState() {
        const input = document.getElementById('chat-input');
        const sendBtn = document.getElementById('chat-send-btn');

        if (!interactionEnabled) {
            input.disabled = true;
            input.placeholder = '16:30ì— ì±„íŒ…ì°½ì´ ì—´ë¦½ë‹ˆë‹¤.';
            sendBtn.disabled = true;
        } else if (chatEnabled) {
            input.disabled = false;
            input.placeholder = 'ë©”ì‹œì§€ ì…ë ¥ (ìµœëŒ€ 30ì)';
            if (!chatCooldown) sendBtn.disabled = false;
        }
    }

    // ì¶”ì²¨ ì°¸ì—¬ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateRaffleInteractionState() {
        const joinBtn = document.getElementById('raffle-join-btn');
        const statusEl = document.getElementById('raffle-status');

        if (!joinBtn) return;

        if (myRaffleNumber) {
            // ì´ë¯¸ ì°¸ì—¬í•œ ê²½ìš° - ê¸°ì¡´ ë¡œì§ ìœ ì§€
            return;
        }

        if (!interactionEnabled) {
            joinBtn.disabled = true;
            joinBtn.classList.add('interaction-disabled');
            joinBtn.innerText = 'ì•„ì§ ì°¸ì—¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
            if (statusEl) statusEl.innerText = 'ê´€ë¦¬ìê°€ ì—´ë©´ ì°¸ì—¬í•  ìˆ˜ ìˆì–´ìš”';
        } else {
            joinBtn.disabled = false;
            joinBtn.classList.remove('interaction-disabled');
            joinBtn.innerText = 'ì¶”ì²¨ ì°¸ì—¬í•˜ê¸°';
            if (statusEl) statusEl.innerText = 'ì°¸ì—¬í•˜ë©´ ë²ˆí˜¸ë¥¼ ë°›ì•„ìš”';
        }
    }

    // ì´ˆê¸°í™”
    generateSetlist();
    setupHeartListeners();
</script>

</body>
</html>
